# 石板谜题 (Stone Slab Puzzle)

一个基于 Python Flask 后端和纯 JavaScript/HTML/CSS 前端的管道连接谜题游戏。玩家可以生成随机谜题、手动拖动石板完成连线，也可以上传图片让程序识别并求解。参考原型：雷霆游戏旗下手游[《仗剑传说》](https://game.leiting.com/list/zjcs/home)

### **主要功能**

* **谜题生成**：能够动态生成不同尺寸和难度的随机可解谜题。
* **拖动操作**：支持直观的拖动功能，允许玩家通过交换石板来解决谜题。
* **自动求解**：使用回溯算法求解，并以动画形式展示解题步骤。
* **图像识别**：支持上传图片，利用OpenCV库识别图片中的石板谜题并自动求解。

---

### **安装与运行**

我们提供两种运行方式：通过 Docker 部署 (推荐) 和本地环境部署。

### **方式一：Docker 快速部署 (推荐)**

使用 Docker 是最简单、最可靠的部署方式，它可以避免复杂的环境配置和依赖问题。

#### **先决条件**

* 已安装 [Docker](https://www.docker.com/get-started/)

#### **步骤**

1.  **构建 Docker 镜像**:
    在项目根目录下，打开终端并运行以下命令：
    ```bash
    docker build -t web-puzzle .
    ```

2.  **启动 Docker 容器**:
    镜像构建成功后，运行以下命令来启动应用：
    ```bash
    docker run -d -p 5000:5000 --name web-puzzle-container web-puzzle
    ```
    * `-d`: 后台运行容器。
    * `-p 5000:5000`: 将您电脑的5000端口映射到容器的5000端口。
    * `--name web-puzzle-container`: 为容器指定一个名称。

3.  **访问应用**:
    打开您的浏览器，访问 `http://127.0.0.1:5000` 即可开始游戏。

---

### **方式二：在本地环境部署**

如果您希望在本地直接运行，请遵循以下步骤。

#### **先决条件**

* Python 3.12 或更高版本
* `pip` 包管理器

#### **系统依赖 (重要)**

本项目的图像识别功能依赖于 `OpenCV` 库。`OpenCV` 不仅需要通过 `pip` 安装，还需要操作系统提供图形处理相关的底层共享库。

在某些最小化安装的系统（如部分云服务器）上，这些库可能没有预装。如果你在运行时遇到类似下面的错误：
`ImportError: libGL.so.1: cannot open shared object file: No such file or directory`

这说明你需要手动安装缺失的系统依赖。以下是一些常见 Linux 发行版的安装命令：

* **对于 Debian/Ubuntu 系统:**
    ```bash
    sudo apt-get update && sudo apt-get install -y libgl1 libglib2.0-0
    ```
* **对于 Fedora/CentOS/RHEL 系统:**
    ```bash
    sudo dnf install mesa-libGL glib2
    ```
* **对于 Arch Linux 系统:**
    ```bash
    sudo pacman -S mesa glib2
    ```

安装完成后，再继续后续步骤。

#### **步骤**

我们提供两种本地安装和启动方式，您可以根据自己的包管理器偏好任选其一。

**选项 A: 使用 uv (推荐)**

1.  **安装依赖**:
    确保你已安装 `uv` 并且处理好了上述系统依赖。 在项目根目录下，运行以下命令：
    ```bash
    uv sync
    ```

2.  **启动服务器**:
    运行以下命令来启动 Flask 应用：
    ```bash
    uv run app.py
    ```
    服务器将在 `http://120.0.0.1:5000` 上启动。

---

**选项 B: 使用 pip (在虚拟环境中)**

我们强烈建议在虚拟环境中安装依赖，以避免与系统中的其他Python包产生冲突。

1.  **创建虚拟环境**:
    在项目根目录下，运行以下命令来创建一个名为 `.venv` 的虚拟环境：
    ```bash
    python -m venv .venv
    ```

2.  **激活虚拟环境**:
    * **在 Windows 上**:
        ```bash
        .\.venv\Scripts\activate
        ```
    * **在 macOS 或 Linux 上**:
        ```bash
        source .venv/bin/activate
        ```
    *激活成功后，您应该会在终端提示符前看到 `(.venv)` 字样。*

3.  **安装依赖**:
    在**已激活**的虚拟环境中，运行以下命令：
    ```bash
    pip install .
    ```
    *(`pip` 会自动读取 `pyproject.toml` 文件并安装依赖)*

4.  **启动服务器**:
    确保虚拟环境仍处于激活状态，然后运行：
    ```bash
    python app.py
    ```
    服务器将在 `http://127.0.0.1:5000` 上启动。

5.  **退出虚拟环境** (可选):
    当您使用完毕后，可以运行以下命令退出虚拟环境：
    ```bash
    deactivate
    ```

---

### **使用说明**

1.  **访问应用**：
    在浏览器中打开 `http://127.0.0.1:5000` 即可开始游戏。

2.  **开始新游戏**：
    在页面顶部的“新游戏”部分，选择你喜欢的难度（例如“简单”、“中等”、“困难”），即可生成一个随机谜题。

3.  **玩游戏**：
    * 用鼠标**拖动**一个石板，然后将其释放到另一个石板上，两者将自动交换位置。
    * 你的目标是连接所有管道，使它们形成一个完整、无中断的网络。

4.  **求解谜题**：
    * 如果你陷入困境，可以点击“**求解**”按钮。程序将自动计算出完成谜题的最少交换步骤，并以动画形式展示出来。
    * 你也可以点击“**重玩**”按钮，将棋盘重置回最初的打乱状态。

5.  **上传图片**：
    * 点击“**上传图片**”按钮，选择一张包含石板谜题的图片。
    * 后台的图像识别模块将自动识别图片中的谜题，并立即为你生成一个可玩的棋盘。

### **文件结构**

* `app.py`：项目的后端主文件，基于 Flask 框架，负责处理所有的 API 请求和页面渲染。
* `game_logic.py`：定义了游戏的核心数据结构，包括 `Tile`（石板）和 `Board`（棋盘）类。
* `puzzle_generator.py`：包含用于生成可解谜题的逻辑。
* `solver.py`：实现了用于自动求解谜题的回溯算法。
* `vision.py`：包含了使用 OpenCV 进行图像识别的代码，用于分析上传的图片。
* `pyproject.toml`：项目的依赖管理文件。
* `Dockerfile`：用于构建 Docker 镜像的配置文件。
* `static/`：存放前端静态文件。
* `templates/`：存放 HTML 模板。
* `uploads/`：一个临时文件夹，用于存储上传的图片。